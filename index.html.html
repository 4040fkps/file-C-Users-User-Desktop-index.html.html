<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Canvas Shooter Ultimate</title>
<style>
body { margin:0; overflow:hidden; background:#000; }
canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
/* ======================
   Canvas
====================== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
resize();
window.onresize = resize;
function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}

/* ======================
   遊戲狀態
====================== */
let gameState = "menu"; // menu | playing

/* ======================
   選單資料
====================== */
let selectedWeapon = "pistol";
let selectedDifficulty = "normal";

const weapons = {
  pistol:  { dmg:1, cooldown:250, speed:8 },
  shotgun:{ dmg:0.6, cooldown:600, pellets:5, spread:0.4 },
  sniper: { dmg:4, cooldown:900, speed:14 }
};

const difficulties = {
  easy:   { enemySpeed:0.8, spawnRate:1400 },
  normal: { enemySpeed:1,   spawnRate:1000 },
  hard:   { enemySpeed:1.4, spawnRate:700 }
};

let spawnTimer;

/* ======================
   玩家
====================== */
const player = {
  x: canvas.width/2,
  y: canvas.height/2,
  r: 12,
  speed: 4,
  hp: 100,
  maxHp: 100,
  invincible: false,
  rollCD: 0,
  rolling: false,
  rollTime: 0
};

const keys = {};
window.onkeydown = e => keys[e.key] = true;
window.onkeyup = e => keys[e.key] = false;

/* ======================
   武器
====================== */
let weapon = {};

function applyWeapon(){
  Object.assign(weapon, weapons[selectedWeapon]);
  weapon.level = 1;
  weapon.exp = 0;
}

function upgradeWeapon(){
  weapon.level++;
  weapon.dmg += 0.5;
  weapon.cooldown *= 0.9;
}

/* ======================
   子彈時間
====================== */
let bulletTime = {
  active:false,
  energy:100,
  max:100
};

/* ======================
   滑鼠 / 子彈
====================== */
let mouseX=0, mouseY=0;
canvas.onmousemove = e=>{
  mouseX=e.clientX;
  mouseY=e.clientY;
};

const bullets=[];
let lastShot=0;

canvas.onclick = ()=>{
  if(gameState!=="playing") return;

  const now=Date.now();
  if(now-lastShot<weapon.cooldown) return;
  lastShot=now;

  const baseAngle=Math.atan2(mouseY-player.y,mouseX-player.x);

  if(selectedWeapon==="shotgun"){
    for(let i=0;i<weapon.pellets;i++){
      const a=baseAngle+(Math.random()-0.5)*weapon.spread;
      bullets.push({
        x:player.x,y:player.y,
        vx:Math.cos(a)*weapon.speed,
        vy:Math.sin(a)*weapon.speed,
        life:50
      });
    }
  }else{
    bullets.push({
      x:player.x,y:player.y,
      vx:Math.cos(baseAngle)*weapon.speed,
      vy:Math.sin(baseAngle)*weapon.speed,
      life:80
    });
  }
};

/* ======================
   敵人
====================== */
const enemies=[];

function spawnEnemy(isBoss=false){
  enemies.push({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    hp:isBoss?80:15,
    speed:(isBoss?0.6:1.2)*difficulties[selectedDifficulty].enemySpeed,
    boss:isBoss
  });
}

/* ======================
   主選單
====================== */
function drawMenu(){
  ctx.fillStyle="white";
  ctx.textAlign="center";
  ctx.font="36px sans-serif";
  ctx.fillText("Canvas Shooter Ultimate",canvas.width/2,120);

  ctx.font="22px sans-serif";
  ctx.fillText("選擇武器：",canvas.width/2,200);
  ctx.fillText("1 手槍   2 霰彈   3 狙擊",canvas.width/2,240);

  ctx.fillText("選擇難度：",canvas.width/2,300);
  ctx.fillText("Q 簡單   W 普通   E 困難",canvas.width/2,340);

  ctx.fillText("Enter 開始遊戲",canvas.width/2,420);
  ctx.textAlign="left";
}

window.addEventListener("keydown",e=>{
  if(gameState!=="menu") return;

  if(e.key==="1") selectedWeapon="pistol";
  if(e.key==="2") selectedWeapon="shotgun";
  if(e.key==="3") selectedWeapon="sniper";

  if(e.key==="q") selectedDifficulty="easy";
  if(e.key==="w") selectedDifficulty="normal";
  if(e.key==="e") selectedDifficulty="hard";

  if(e.key==="Enter"){
    startGame();
  }
});

/* ======================
   開始遊戲
====================== */
function startGame(){
  gameState="playing";
  applyWeapon();

  spawnTimer=setInterval(()=>{
    spawnEnemy(Math.random()<0.2);
  },difficulties[selectedDifficulty].spawnRate);
}

/* ======================
   主迴圈
====================== */
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(gameState==="menu"){
    drawMenu();
    requestAnimationFrame(loop);
    return;
  }

  const timeScale=bulletTime.active?0.3:1;

  let mx=0,my=0;
  if(keys.w) my--;
  if(keys.s) my++;
  if(keys.a) mx--;
  if(keys.d) mx++;

  if(player.rolling){
    player.rollTime--;
    player.invincible=true;
    player.x+=mx*10;
    player.y+=my*10;
    if(player.rollTime<=0){
      player.rolling=false;
      player.invincible=false;
      player.rollCD=120;
    }
  }else{
    player.x+=mx*player.speed;
    player.y+=my*player.speed;
  }

  if(player.rollCD>0) player.rollCD--;

  if(keys.Shift && !player.rolling && player.rollCD<=0){
    player.rolling=true;
    player.rollTime=12;
  }

  if(keys[" "] && bulletTime.energy>0){
    bulletTime.active=true;
    bulletTime.energy--;
  }else{
    bulletTime.active=false;
    bulletTime.energy=Math.min(bulletTime.max,bulletTime.energy+0.5);
  }

  bullets.forEach((b,i)=>{
    b.x+=b.vx*timeScale;
    b.y+=b.vy*timeScale;
    b.life--;
    ctx.fillStyle="yellow";
    ctx.fillRect(b.x-2,b.y-2,4,4);
    if(b.life<=0) bullets.splice(i,1);
  });

  enemies.forEach((e,ei)=>{
    const dx=player.x-e.x,dy=player.y-e.y;
    const d=Math.hypot(dx,dy)||1;
    e.x+=dx/d*e.speed*timeScale;
    e.y+=dy/d*e.speed*timeScale;

    bullets.forEach((b,bi)=>{
      if(Math.hypot(b.x-e.x,b.y-e.y)<16){
        e.hp-=weapon.dmg;
        bullets.splice(bi,1);
      }
    });

    if(!player.invincible && d<20) player.hp--;

    if(e.hp<=0){
      enemies.splice(ei,1);
      weapon.exp++;
      if(weapon.exp%5===0) upgradeWeapon();
    }

    ctx.fillStyle=e.boss?"purple":"red";
    ctx.beginPath();
    ctx.arc(e.x,e.y,16,0,Math.PI*2);
    ctx.fill();
  });

  ctx.fillStyle=player.invincible?"cyan":"white";
  ctx.beginPath();
  ctx.arc(player.x,player.y,player.r,0,Math.PI*2);
  ctx.fill();

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
